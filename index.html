<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.54.0/dist/phaser.js"></script>
</head>

<body class="min-vh-100 min-vw-100 d-flex justify-content-center align-items-center bg-secondary">
    <nav class="navbar fixed-top navbar-dark p-0" id="navtop">
        <div class="container-fluid w-100 bg-dark">
            <div class="d-flex justify-content-between w-100">
                <div class="navbar-brand d-flex justify-content-between align-items-center m-0">
                    <buttom class="btn btn-outline-light p-2 m-2" id="seeding"><img src="assets/seeding.png"
                            class="img-fluid max-height-64" alt="seeding"></buttom>
                    <buttom class="btn btn-outline-light p-2 m-2" id="mission"><img src="assets/target.png"
                            class="img-fluid max-height-64" alt="target"></buttom>
                </div>
                <div class="navbar-brand d-flex justify-content-center align-items-center m-0">
                    <img src="assets/dollar.png" alt="coin" width="64" height="64">
                    <span id="coins" class="mx-2"></span>
                </div>
            </div>
        </div>
        <div class="d-flex flex-column flex-shrink-0 p-3 text-bg-dark bg-dark w-100 bg-opacity-25" id="side-seeding"
            style="visibility: hidden;">
            <div class="text-white text-center">
                <span class="fs-1">Seeding</span>
            </div>
            <hr>
            <div class="container">
                <div class="row overflow-auto" style="max-height: 50vh;">
                    <div class="col d-flex justify-content-center align-items-center">
                        <buttom class="btn btn-outline-light p-2 m-2" id="wheat-icon">
                            <div>Wheat</div><img src="assets/wheat-icon.png" class="img-fluid max-height-64"
                                alt="wheat-icon">
                            <div>10</div>
                        </buttom>
                    </div>
                    <div class="col d-flex justify-content-center align-items-center">
                        <buttom class="btn btn-outline-light p-2 m-2" id="wheat-icon">
                            <div>Tomato</div><img src="assets/tomato-icon.png" class="img-fluid max-height-64"
                                alt="wheat-icon">
                            <div>6</div>
                        </buttom>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark" id="navbot">
        <div class="container-fluid">
            <div class="d-flex justify-content-between w-100">
                <buttom class="btn btn-outline-light p-2 m-2" id="shovel"><img src="assets/shovel.png"
                        class="img-fluid max-height-64" alt="shovel"></buttom>
                <buttom class="btn btn-outline-light p-2 m-2" id="plant"><img src="assets/plant.png" alt="plant"
                        class="img-fluid max-height-64"></buttom>
                <buttom class="btn btn-outline-light p-2 m-2" id="watering-can"><img src="assets/watering-can.png"
                        alt="watering-can" class="img-fluid max-height-64"></buttom>
                <buttom class="btn btn-outline-light p-2 m-2" id="scythe"><img src="assets/scythe.png" alt="scythe"
                        class="img-fluid max-height-64"></buttom>
            </div>
        </div>
    </nav>
    <script src="js/phaser.min.js"></script>
    <script src="js/phaser-plugin-isometric.min.js"></script>
    <script>
        //LAYOUT
        document.getElementById("seeding").addEventListener("click", function () {
            var div = document.getElementById('side-seeding');
            if (div.style.visibility === "hidden") {
                div.style.visibility = "visible";
            } else {
                div.style.visibility = "hidden";
            }
        });

        //CONFIG
        var navTop = document.getElementById("navtop");
        var navTopHeight = navTop.offsetHeight;

        var navBot = document.getElementById("navbot");
        var navBotHeight = navBot.offsetHeight;

        var width = window.innerWidth * 0.85;
        var height = window.innerHeight - navTopHeight;

        if (height > 720) {
            height = 720
        }

        var game = new Phaser.Game(width, height, Phaser.AUTO, 'test', null, true, false);
        var BasicGame = function (game) { };
        BasicGame.Boot = function (game) { };
        var isoGroup, cursorPos, cursor;

        //VARIABLES
        var map = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 3, 3, 3, 3, 0, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 6, 6, 6, 0, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 5, 5, 5, 0, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 5, 4, 4, 0, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 5, 4, 1, 0, 7, 7, 7, 7, 7, 7, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 8, 8, 0, 0, 8, 8, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 8, 0, 0, 0, 0, 8, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 8, 0, 0, 0, 0, 8, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 8, 8, 0, 0, 8, 8, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        ];

        var coins = 100;

        //CONST
        const size = 35.8;
        const speed = 100;
        const digCost = 10;
        const plantCost = 5;
        const wateringCost = 5;
        const cropsRevenue = 30;
        const characterStartX = 10;
        const characterStartY = 10;
        const dict = {
            grass: 0,
            noGrass: 1,
            treeGrass: 2,
            wheatNoGrass: 3,
            shootNoGrass: 4,
            wateringNoGrass: 5,
            shootWateringNoGrass: 6,
            tomatoNoGrass: 7,
            rockGrass: 8,
        };

        BasicGame.Boot.prototype =
        {
            //INSIDE CREATE FUNCTIONS
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            gameAdd: function (xx, yy, kind, group, asx, asy, wet = false) {    //player move on
                obj = game.add.isoSprite(xx, yy, 0, kind, 0, group);            //add sprite
                obj.anchor.set(asx, asy);                                       //set anchor
                if (wet == true) {                                              //in case WateringNoGrass
                    obj.tint = 0x86bfda;                                        //change color
                }
            },
            gameAddWall: function (xx, yy, kind, group, asx, asy) {             //player move off
                obj = game.add.isoSprite(xx, yy, 0, kind, 0, group);            //add sprite
                obj.anchor.set(asx, asy);                                       //set anchor
                game.physics.isoArcade.enable(obj);                             //turn on physics
                obj.body.collideWorldBounds = true;                             //turn on collide
                obj.body.immovable = true;                                      //turn off move
            },
            spawnTilesPlatform: function () {
                /*
                OLD:
                for (var xx = 0; xx < map[0].length * size - size; xx += size) {
                    for (var yy = 0; yy < map.length * size - size; yy += size) {
                        //code
                    };
                };
                */
                for (var i = 0; i < map[0].length * map.length; i++) {
                    var xx = (i % map[0].length) * size;
                    var yy = Math.floor(i / map[0].length) * size;
                    switch (map[parseInt(xx / size)][parseInt(yy / size)]) {
                        case dict.grass: this.gameAdd(xx, yy, 'grass', isoGroupPlatform, 0.5, 0); break;
                        case dict.treeGrass: this.gameAdd(xx, yy, 'grass', isoGroupPlatform, 0.5, 0); break;
                        case dict.rockGrass: this.gameAdd(xx, yy, 'grass', isoGroupPlatform, 0.5, 0); break;
                        case dict.noGrass: this.gameAdd(xx, yy, 'nograss', isoGroupPlatform, 0.5, 0); break;
                        case dict.shootNoGrass: this.gameAdd(xx, yy, 'nograss', isoGroupPlatform, 0.5, 0); break;
                        case dict.wheatNoGrass: this.gameAdd(xx, yy, 'nograss', isoGroupPlatform, 0.5, 0); break;
                        case dict.tomatoNoGrass: this.gameAdd(xx, yy, 'nograss', isoGroupPlatform, 0.5, 0); break;
                        case dict.shootWateringNoGrass: this.gameAdd(xx, yy, 'nograss', isoGroupPlatform, 0.5, 0, true); break;
                        case dict.wateringNoGrass: this.gameAdd(xx, yy, 'nograss', isoGroupPlatform, 0.5, 0, true); break;
                    };
                }
            },
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            spawnTilesSecond: function () {
                for (var i = 0; i < map[0].length * map.length; i++) {
                    var xx = (i % map[0].length) * size;
                    var yy = Math.floor(i / map[0].length) * size;
                    switch (map[parseInt(xx / size)][parseInt(yy / size)]) {
                        case dict.treeGrass: this.gameAddWall(xx, yy, 'tree', isoGroupSecond, 0.5); break;
                        case dict.wheatNoGrass: this.gameAdd(xx, yy, 'wheat', isoGroupSecond, 0.5); break;
                        case dict.shootNoGrass: this.gameAdd(xx, yy, 'shoot', isoGroupSecond, 0.5); break;
                        case dict.shootWateringNoGrass: this.gameAdd(xx, yy, 'shoot', isoGroupSecond, 0.5); break;
                        case dict.tomatoNoGrass: this.gameAdd(xx, yy, 'tomato', isoGroupSecond, 0.5); break;
                        case dict.rockGrass: this.gameAddWall(xx, yy, 'rock', isoGroupSecond, 0.5); break;
                    };
                }
            },
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            //PRELOAD
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            preload: function () {
                //LOAD IMAGES
                game.load.image('grass', 'assets/grass.png');
                game.load.image('nograss', 'assets/nograss.png');
                game.load.image('character', 'assets/character.png');
                game.load.image('tree', 'assets/tree.png');
                game.load.image('wheat', 'assets/wheat.png');
                game.load.image('tomato', 'assets/tomato.png');
                game.load.image('shoot', 'assets/shoot.png');
                game.load.image('rock', 'assets/rock.png');

                //SET UP GAME
                game.time.advancedTiming = true;
                game.plugins.add(new Phaser.Plugin.Isometric(game));            //add plugin
                game.world.setBounds(0, 0, 1496, 1024);                         //add bounds word - need to camera
                game.physics.startSystem(Phaser.Plugin.Isometric.ISOARCADE);    //add plugin physics
                game.iso.anchor.setTo(0.5, 0.0);                                //set anchor

                //LAYOUT SET UP
                document.getElementById("coins").innerHTML += coins;
            },
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            //CREATE
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            create: function () {
                //GRAVITY
                game.physics.isoArcade.gravity.setTo(0, 0, -1000);

                //SPAWN
                isoGroupPlatform = game.add.group();        //create group
                this.spawnTilesPlatform();                  //spawn
                isoGroupSecond = game.add.group();          //create group
                this.spawnTilesSecond();                    //spawn

                //CHARACTER
                player = game.add.isoSprite(size * characterStartX, size * characterStartY, 0, 'character', 0, isoGroupSecond); //add sprite
                player.anchor.set(0.5);                                                                                         //set anchor
                game.physics.isoArcade.enable(player);                                                                          //turn on physics
                player.body.collideWorldBounds = true;                                                                          //turn on collide

                //ADD KEY TO MOVE
                this.cursors = game.input.keyboard.createCursorKeys();  //add keyboard
                this.game.input.keyboard.addKeyCapture([                //add keys
                    Phaser.Keyboard.LEFT,
                    Phaser.Keyboard.RIGHT,
                    Phaser.Keyboard.UP,
                    Phaser.Keyboard.DOWN,
                    Phaser.Keyboard.SPACEBAR
                ]);

                //CAMERA MOVE
                game.camera.follow(player);

            },
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            //UPDATE
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            update: function (todo) {
                //INSIDE FUNCTIONS
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------
                function actionOnclick() {
                    var counter = 0;                                //helper variable to find coords
                    isoGroupPlatform.forEach(function (tile) {      //loop for each element at platform
                        var inBounds = tile.isoBounds.containsXY(player.body.position.x + (size / 2), player.body.position.y + (size / 2));//check player in bounds
                        if (!tile.selected && inBounds) {           //if player in bounds is true and tile is false
                            tile.selected = true;                   //change state                                                                            
                            x = Math.floor(counter / (map.length))  //get coord x
                            y = counter % map.length                //get coord y
                            todo(x, y, tile);                       //fuction to do - takes from argument
                        }
                        else if (tile.selected && !inBounds) {      //if player in bounds is false and tile is true
                            tile.selected = false;                  //change state
                        };
                        counter++;                                  //add to counter
                    });
                };
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------
                function digInside(x, y, tile) {
                    if (coins >= digCost) {                                     //check how many coins has player
                        tile.loadTexture('nograss');                            //change texture
                        map[x][y] = dict.noGrass;                               //update map
                        coins -= digCost;                                       //add coins
                        document.getElementById("coins").innerHTML = coins;     //update coins
                    }
                };
                function dig(x, y, tile) {
                    switch (map[x][y]) {
                        //CHANGE FROM GRASS TO NOGRASS
                        case dict.grass: digInside(x, y, tile); break;
                        //CHANGE FROM NOGRASS TO GRASS
                        case dict.noGrass: digInside(x, y, tile); break;
                    };
                };
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------
                function plantIndide(x, y, tile) {
                    if (coins >= plantCost) {                                                           //check how many coins has player
                        shoot = game.add.isoSprite(x * size, y * size, 0, 'shoot', 0, isoGroupSecond);  //add sprite
                        shoot.anchor.set(0.5);                                                          //set anchor
                        map[x][y] = dict.shootNoGrass;                                                  //update map
                        coins -= plantCost;                                                             //add coins
                        document.getElementById("coins").innerHTML = coins;                             //update coins
                    };
                };
                function plant(x, y, tile) {
                    switch (map[x][y]) {
                        //CHANGE FROM NOGRASS TO SHOOT
                        case dict.noGrass: plantIndide(x, y, tile); break;
                        //CHANGE FROM WATERINGNOGRASS TO SHOOTWATERINGNOGRASS
                        case dict.wateringNoGrass: plantIndide(x, y, tile); break;
                    };
                };
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------
                function wateringInside(x, y, tile) {
                    if (coins >= wateringCost) {                                //check how many coins has player
                        tile.tint = 0x86bfda;                                   //change color
                        map[x][y] = dict.wateringNoGrass;                       //update map
                        coins -= wateringCost;                                  //add coins
                        document.getElementById("coins").innerHTML = coins;     //update coins
                    };
                };
                function watering(x, y, tile) {
                    switch (map[x][y]) {
                        //CHANGE FROM NOGRASS TO WATERINGNOGRASS
                        case dict.noGrass: wateringInside(x, y, tile); break;
                        //CHANGE FROM SHOOT NOGRASS TO SHOOT WATERINGNOGRASS
                        case dict.shootNoGrass: wateringInside(x, y, tile); break;
                    };
                };
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------
                function cropsInside(tile, key) {
                    var counter = 0;                                                            //helper variable
                    var index = 0;                                                              //index of the object from isoGroupSecond
                    var diffX = 1000000;                                                        //helper variable
                    var diffY = 1000000;                                                        //helper variable
                    isoGroupSecond.forEach(function (tileSecond) {                              //loop for each element at 
                        if (tileSecond.key == key) {                                            //do it for key(kind) of object
                            var currDiffX = Math.abs(tile.position.x - tileSecond.position.x);  //take difference x
                            var currDiffY = Math.abs(tile.position.y - tileSecond.position.y);  //take difference y
                            if (currDiffX < diffX || currDiffY < diffY) {                       //take the lower one
                                diffX = currDiffX;                                              //update helper variable
                                diffY = currDiffY;                                              //update helper variable
                                index = counter;                                                //update index
                            };
                        };
                        counter++;                                                              //add to counter
                    });
                    tile.loadTexture('grass');                                                  //change texture
                    map[x][y] = dict.grass;                                                     //update map
                    coins += cropsRevenue;                                                      //add to coins
                    document.getElementById("coins").innerHTML = coins;                         //update coins
                    isoGroupSecond.children[index].destroy();                                   //destroy element from gameplay
                };
                function crops(x, y, tile) {
                    switch (map[x][y]) {
                        //CHANGE TO GRASS
                        case dict.wheatNoGrass: cropsInside(tile, 'wheat'); break;
                        case dict.tomatoNoGrass: cropsInside(tile, 'tomato'); break;
                    };
                };
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------
                //MOVE UPDATE
                player.body.velocity.y = (this.cursors.up.isDown ? -speed : (this.cursors.down.isDown ? speed : 0));    //move top down
                player.body.velocity.x = (this.cursors.left.isDown ? -speed : (this.cursors.right.isDown ? speed : 0)); //move left right


                //ON CLICK SHOVEL
                document.getElementById("shovel").addEventListener("click", function () {
                    actionOnclick(todo = dig);
                });

                //ON CLICK PLANT
                document.getElementById("plant").addEventListener("click", function () {
                    actionOnclick(todo = plant);
                });

                //ON CLICK WATERING-CAN
                document.getElementById("watering-can").addEventListener("click", function () {
                    actionOnclick(todo = watering);
                });

                //ON CLICK SCYTHE
                document.getElementById("scythe").addEventListener("click", function () {
                    actionOnclick(todo = crops);

                });
                //----------------------------------------------------------------------------------------------------------------------------------------------------------------

                //ADD COLLLIDE AND TOPOLOGIC VIEW
                game.physics.isoArcade.collide(isoGroupPlatform);
                game.iso.topologicalSort(isoGroupPlatform);
                game.physics.isoArcade.collide(isoGroupSecond);
                game.iso.topologicalSort(isoGroupSecond);

            },
            //----------------------------------------------------------------------------------------------------------------------------------------------------------------
            render: function () {
                game.debug.text(game.time.fps || '--', 2, 14, "#a7aebe");
            },
        };

        //CONFIG
        game.state.add('Boot', BasicGame.Boot);
        game.state.start('Boot');
    </script>

</body>

</html>
<!--
    0 - /grass
    1 - /nograss
    2 - tree/grass
    3 - wheat/nograss
    4 - shoot/nograss
    5 - /wateringnograss
    6 - shoot/wateringnograss
    7 - tomato/nograss
    8 - rock/grass

    https://www.flaticon.com/search?word=watering%20can
    https://www.flaticon.com/search?word=scythe
    https://www.flaticon.com/search?word=coin
    https://www.flaticon.com/search?word=plant
    https://www.flaticon.com/search?word=planting
    https://www.flaticon.com/search?word=mission
    https://www.flaticon.com/search?word=wheat
    https://www.flaticon.com/search?word=tomato
-->