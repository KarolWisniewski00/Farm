<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.54.0/dist/phaser.js"></script>
</head>

<body class="min-vh-100 min-vw-100 d-flex justify-content-center align-items-center bg-secondary">
    <nav class="navbar fixed-top navbar-dark bg-dark" id="navtop">
        <div class="container-fluid">
            <div class="d-flex justify-content-end w-100">
                <div class="navbar-brand d-flex justify-content-center align-items-center m-0">
                    <img src="assets/dollar.png" alt="coin" width="64" height="64">
                    <span id="coins" class="mx-2"></span>
                </div>
            </div>
        </div>
    </nav>
    <nav class="navbar fixed-bottom navbar-expand-sm navbar-dark bg-dark" id="navbot">
        <div class="container-fluid">
            <div class="d-flex justify-content-between w-100">
                <buttom class="btn btn-success p-2 m-2" id="shovel"><img src="assets/shovel.png"
                        class="img-fluid max-height-64" alt="shovel"></buttom>
                <buttom class="btn btn-success p-2 m-2" id="plant"><img src="assets/plant.png" alt="plant"
                        class="img-fluid max-height-64"></buttom>
                <buttom class="btn btn-success p-2 m-2" id="watering-can"><img src="assets/watering-can.png"
                        alt="watering-can" class="img-fluid max-height-64"></buttom>
                <buttom class="btn btn-success p-2 m-2" id="scythe"><img src="assets/scythe.png" alt="scythe"
                        class="img-fluid max-height-64"></buttom>
            </div>
        </div>
    </nav>
    <script src="js/phaser.min.js"></script>
    <script src="js/phaser-plugin-isometric.min.js"></script>
    <script>
        //CONFIG
        var navTop = document.getElementById("navtop");
        var navTopStyles = window.getComputedStyle(navTop);
        var navTopHeight = navTop.offsetHeight;

        var navBot = document.getElementById("navbot");
        var navBotStyles = window.getComputedStyle(navBot);
        var navBotHeight = navBot.offsetHeight;

        var width = window.innerWidth * 0.75;
        var height = window.innerHeight - navTopHeight - navBotHeight;

        if (height > 720) {
            height = 720
        }

        var game = new Phaser.Game(width, height, Phaser.AUTO, 'test', null, true, false);
        var BasicGame = function (game) { };
        BasicGame.Boot = function (game) { };
        var isoGroup, cursorPos, cursor;

        //VARIABLES
        var map = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 6, 6, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 5, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 2, 3, 6, 5, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        ];

        var coins = 100;

        const size = 35.8;
        const speed = 100;

        BasicGame.Boot.prototype =
        {
            //--------------------------------------------------------------------------------
            preload: function () {
                //LOAD IMAGES
                game.load.image('grass', 'assets/grass.png');
                game.load.image('nograss', 'assets/nograss.png');
                game.load.image('character', 'assets/character.png');
                game.load.image('tree', 'assets/tree.png');
                game.load.image('wheat', 'assets/wheat.png');
                game.load.image('shoot', 'assets/shoot.png');

                //SET UP GAME
                game.time.advancedTiming = true;
                game.plugins.add(new Phaser.Plugin.Isometric(game));
                game.world.setBounds(0, 0, 1496, 1024);
                game.physics.startSystem(Phaser.Plugin.Isometric.ISOARCADE);
                game.iso.anchor.setTo(0.5, 0.0);

                //LAYOUT SET UP
                document.getElementById("coins").innerHTML += coins;
            },
            //--------------------------------------------------------------------------------
            create: function () {
                //GRAVITY
                game.physics.isoArcade.gravity.setTo(0, 0, -1000);

                //SPAWN
                isoGroupPlatform = game.add.group();
                this.spawnTilesPlatform();
                isoGroupSecond = game.add.group();
                this.spawnTilesSecond();

                //CHARACTER
                player = game.add.isoSprite(size * 10, size * 10, 0, 'character', 0, isoGroupSecond);
                player.anchor.set(0.5);
                game.physics.isoArcade.enable(player);
                player.body.collideWorldBounds = true;

                //ADD KEY TO MOVE
                this.cursors = game.input.keyboard.createCursorKeys();
                this.game.input.keyboard.addKeyCapture([
                    Phaser.Keyboard.LEFT,
                    Phaser.Keyboard.RIGHT,
                    Phaser.Keyboard.UP,
                    Phaser.Keyboard.DOWN,
                    Phaser.Keyboard.SPACEBAR
                ]);

                //CAMERA MOVE
                game.camera.follow(player);

            },
            //--------------------------------------------------------------------------------
            update: function () {
                //MOVE UPDATE
                player.body.velocity.y = (this.cursors.up.isDown ? -speed : (this.cursors.down.isDown ? speed : 0));
                player.body.velocity.x = (this.cursors.left.isDown ? -speed : (this.cursors.right.isDown ? speed : 0));

                //ACTION ON CLICK SHOVEL
                document.getElementById("shovel").addEventListener("click", function () {
                    var counter = 0;
                    isoGroupPlatform.forEach(function (tile) {
                        var inBounds = tile.isoBounds.containsXY(player.body.position.x + (size / 2), player.body.position.y + (size / 2));
                        if (!tile.selected && inBounds) {
                            tile.selected = true;

                            x = Math.floor(counter / (map.length))
                            y = counter % map.length

                            //CHANGE FROM GRASS TO NOGRASS
                            if (map[x][y] == 0) {
                                if (coins >= 10) {
                                    tile.loadTexture('nograss');
                                    map[x][y] = 1;
                                    coins -= 10;
                                    document.getElementById("coins").innerHTML = coins;
                                }

                                //CHANGE FROM NOGRASS TO GRASS
                            } else if (map[x][y] == 1) {
                                if (coins >= 10) {
                                    tile.loadTexture('grass');
                                    map[x][y] = 0;
                                    coins -= 10;
                                    document.getElementById("coins").innerHTML = coins;
                                }
                            }
                        }
                        else if (tile.selected && !inBounds) {
                            tile.selected = false;
                        }
                        counter++;
                    });
                });

                //ACTION ON CLICK PLANT
                document.getElementById("plant").addEventListener("click", function () {
                    var counter = 0;
                    isoGroupPlatform.forEach(function (tile) {
                        var inBounds = tile.isoBounds.containsXY(player.body.position.x + (size / 2), player.body.position.y + (size / 2));
                        if (!tile.selected && inBounds) {
                            tile.selected = true;

                            x = Math.floor(counter / (map.length))
                            y = counter % map.length

                            //CHANGE FROM NOGRASS TO SHOOT
                            if (map[x][y] == 1) {
                                if (coins >= 5) {
                                    shoot = game.add.isoSprite(x * size, y * size, 0, 'shoot', 0, isoGroupSecond);
                                    shoot.anchor.set(0.5);
                                    map[x][y] = 4;
                                    coins -= 5;
                                    document.getElementById("coins").innerHTML = coins;
                                }

                                //CHANGE FROM NOGRASS TO SHOOT
                            } else if (map[x][y] == 5) {
                                if (coins >= 5) {
                                    shoot = game.add.isoSprite(x * size, y * size, 0, 'shoot', 0, isoGroupSecond);
                                    shoot.anchor.set(0.5);
                                    map[x][y] = 6;
                                    coins -= 5;
                                    document.getElementById("coins").innerHTML = coins;
                                }
                            }
                        }
                        else if (tile.selected && !inBounds) {
                            tile.selected = false;
                        }
                        counter++;
                    });
                });

                //ACTION ON CLICK WATERING-CAN
                document.getElementById("watering-can").addEventListener("click", function () {
                    var counter = 0;
                    isoGroupPlatform.forEach(function (tile) {
                        var inBounds = tile.isoBounds.containsXY(player.body.position.x + (size / 2), player.body.position.y + (size / 2));
                        if (!tile.selected && inBounds) {
                            tile.selected = true;

                            x = Math.floor(counter / (map.length))
                            y = counter % map.length

                            //CHANGE FROM NOGRASS TO WATERINGNOGRASS
                            if (map[x][y] == 1) {
                                if (coins >= 5) {
                                    tile.tint = 0x86bfda;
                                    map[x][y] = 5;
                                    coins -= 5;
                                    document.getElementById("coins").innerHTML = coins;
                                }

                                //CHANGE FROM SHOOT NOGRASS TO SHOOT WATERINGNOGRASS
                            } else if (map[x][y] == 4) {
                                if (coins >= 5) {
                                    tile.tint = 0x86bfda;
                                    map[x][y] = 6;
                                    coins -= 5;
                                    document.getElementById("coins").innerHTML = coins;
                                }
                            }
                        }
                        else if (tile.selected && !inBounds) {
                            tile.selected = false;
                        }
                        counter++;
                    });
                });

                //ACTION ON CLICK SCYTHE
                document.getElementById("scythe").addEventListener("click", function () {
                    var counter = 0;
                    isoGroupPlatform.forEach(function (tile) {
                        var inBounds = tile.isoBounds.containsXY(player.body.position.x + (size / 2), player.body.position.y + (size / 2));
                        if (!tile.selected && inBounds) {
                            tile.selected = true;

                            x = Math.floor(counter / (map.length))
                            y = counter % map.length

                            //CHANGE FROM WHEAT TO GRASS
                            if (map[x][y] == 3) {
                                var counterSecond = 0;
                                var index = 0;
                                var diffX = 1000000;
                                var diffY = 1000000;
                                isoGroupSecond.forEach(function (tileSecond) {
                                    if (tileSecond.key == 'wheat') {
                                        var currDiffX = Math.abs(player.position.x - tileSecond.position.x);
                                        var currDiffY = Math.abs(player.position.y - tileSecond.position.y);
                                        if (currDiffX < diffX || currDiffY < diffY) {
                                            diffX = currDiffX;
                                            diffY = currDiffY;
                                            index = counterSecond;
                                        }
                                    }
                                    counterSecond++;
                                });
                                tile.loadTexture('grass');
                                map[x][y] = 0;
                                coins += 30;
                                document.getElementById("coins").innerHTML = coins;
                                isoGroupSecond.children[index].destroy();
                            }
                        }
                        else if (tile.selected && !inBounds) {
                            tile.selected = false;
                        }
                        counter++;
                    });
                });

                game.physics.isoArcade.collide(isoGroupPlatform);
                game.iso.topologicalSort(isoGroupPlatform);
                game.physics.isoArcade.collide(isoGroupSecond);
                game.iso.topologicalSort(isoGroupSecond);

            },
            //--------------------------------------------------------------------------------
            spawnTilesPlatform: function () {
                for (var xx = 0; xx < map[0].length * size - size; xx += size) {
                    for (var yy = 0; yy < map.length * size - size; yy += size) {
                        if ((map[parseInt(xx / size)][parseInt(yy / size)] == 0) || (map[parseInt(xx / size)][parseInt(yy / size)] == 2)) {
                            //GRASS
                            grass = game.add.isoSprite(xx, yy, 0, 'grass', 0, isoGroupPlatform);
                            grass.anchor.set(0.5, 0);
                        } else if (map[parseInt(xx / size)][parseInt(yy / size)] == 1 || (map[parseInt(xx / size)][parseInt(yy / size)] == 3) || (map[parseInt(xx / size)][parseInt(yy / size)] == 4)) {
                            //NOGRASS
                            nograss = game.add.isoSprite(xx, yy, 0, 'nograss', 0, isoGroupPlatform);
                            nograss.anchor.set(0.5, 0);
                        } else if (map[parseInt(xx / size)][parseInt(yy / size)] == 5 || (map[parseInt(xx / size)][parseInt(yy / size)] == 6)) {
                            //NOGRASS
                            nograss = game.add.isoSprite(xx, yy, 0, 'nograss', 0, isoGroupPlatform);
                            nograss.anchor.set(0.5, 0);
                            nograss.tint = 0x86bfda;
                        }
                    }
                }
            },
            //--------------------------------------------------------------------------------
            spawnTilesSecond: function () {
                for (var xx = 0; xx < map[0].length * size; xx += size) {
                    for (var yy = 0; yy < map.length * size; yy += size) {
                        if (map[parseInt(xx / size)][parseInt(yy / size)] == 2) {
                            //TREE
                            tree = game.add.isoSprite(xx, yy, 0, 'tree', 0, isoGroupSecond);
                            tree.anchor.set(0.5);
                            game.physics.isoArcade.enable(tree);
                            tree.body.collideWorldBounds = true;
                            tree.body.immovable = true;
                        } else if (map[parseInt(xx / size)][parseInt(yy / size)] == 3) {
                            //WHEAT
                            wheat = game.add.isoSprite(xx, yy, 0, 'wheat', 0, isoGroupSecond);
                            wheat.anchor.set(0.5);
                        } else if (map[parseInt(xx / size)][parseInt(yy / size)] == 4 || (map[parseInt(xx / size)][parseInt(yy / size)] == 6)) {
                            //SHOOT
                            shoot = game.add.isoSprite(xx, yy, 0, 'shoot', 0, isoGroupSecond);
                            shoot.anchor.set(0.5);
                        }
                    }
                }
            },
            //--------------------------------------------------------------------------------
            render: function () {
                game.debug.text(game.time.fps || '--', 2, 14, "#a7aebe");
            },
        };

        //CONFIG
        game.state.add('Boot', BasicGame.Boot);
        game.state.start('Boot');
    </script>

</body>

</html>
<!--
    0 - /grass
    1 - /nograss
    2 - tree/grass
    3 - wheat/nograss
    4 - shoot/nograss
    5 - /wateringnograss
    6 - shoot/wateringnograss

    todo:
    prszyciski ekranowe do navigacji
    lista zadań
    przedmioty
    https://www.flaticon.com/search?word=watering%20can
    https://www.flaticon.com/search?word=scythe
    https://www.flaticon.com/search?word=coin
    https://www.flaticon.com/search?word=plant
-->